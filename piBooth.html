
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>pi Booth</title>

  <link rel="stylesheet" type="text/css" href="css/piBooth.css">
  <link rel="stylesheet" type="text/css" href="paper-ripple/paper-ripple.min.css">
  <script type="text/javascript" src="paper-ripple/PaperRipple.min.js"> </script>
</head>

<body>
  <button class="paper-button" id="take-picture-button">
    <span id="button-text">TAKE PICTURE</span>
    <div class="loader hidden" id="taking-picture-loader"></div>
  </button>

  <script language="javascript">
    var button = document.getElementById('take-picture-button');
    var text = document.getElementById('button-text');
    var loader = document.getElementById('taking-picture-loader');
    var busy = false;
    var maxCount = 3;

    // set up picture taking events
    var pictureTaken = function() {
      loader.classList.add('hidden');
      text.innerHTML = 'PICTURE TAKEN!';
      setTimeout(function() {
        busy = false;
        text.innerHTML = 'TAKE PICTURE';
      }, 750);
    };

    var countDown = function() {
      return new Promise((resolve, reject) => {
        var count = maxCount;
        text.innerHTML = count;

        var iterate = function() {
          count--;
          if(count === 0) {
            resolve();
          } else {
            text.innerHTML = count;
            setTimeout(iterate, 1000);
          }
        };

        setTimeout(iterate, 1000);
      });
    };

    var sendCaptureRequest = function(callback) {
      return new Promise((resolve, reject) => {
        var xhr = new XMLHttpRequest();
        xhr.open('POST', 'http://localhost:8443/capture');
        xhr.onreadystatechange = function() {
          if (xhr.readyState>3 && xhr.status==200) {
             resolve();
          }
        };
        xhr.send();
      });
    };

    var takePicture = function() {
      busy = true;
      countDown().then(() => {
        loader.classList.remove('hidden');
        text.innerHTML = 'CAPTURING, PLEASE WAIT';
        sendCaptureRequest().then(pictureTaken);
      });
    };

    button.addEventListener('click', function() {
      if(!busy) {
        takePicture();
      }
    });

    // set up ripple animations
    var ripple = new PaperRipple();

    button.appendChild(ripple.$);

    button.addEventListener('mousedown', function(event) {
      ripple.downAction(event);
    });

    button.addEventListener('mouseup', function(event) {
      ripple.upAction(event);
    });

  </script>
</body>
</html>
